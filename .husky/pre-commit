#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Checking for relevant file changes..."

# Get list of staged files
staged_files=$(git diff --cached --name-only)

# Define patterns for files that should trigger tests
test_relevant_patterns=(
  "\.js$"
  "\.jsx$"
  "\.ts$"
  "\.tsx$"
  "\.json$"
  "package\.json$"
  "package-lock\.json$"
  "yarn\.lock$"
  "pnpm-lock\.yaml$"
  "\.test\."
  "\.spec\."
  "__tests__"
  "src/"
  "lib/"
  "components/"
)

# Check if any staged files match our patterns
should_run_tests=false
for file in $staged_files; do
  for pattern in "${test_relevant_patterns[@]}"; do
    if echo "$file" | grep -E "$pattern" > /dev/null; then
      should_run_tests=true
      break 2
    fi
  done
done

if [ "$should_run_tests" = false ]; then
  echo "â­ï¸  No test-relevant files changed - skipping tests"
else
  echo "ğŸ§ª Running tests before commit..."
  pnpm run test:packages --browser.headless=true

  if [ $? -ne 0 ]; then
    echo "âŒ Tests failed - aborting commit."
    exit 1
  fi
fi

echo "ğŸ“¦ Building packages..."
pnpm run build:packages

if [ $? -ne 0 ]; then
  echo "âŒ Build failed - aborting commit."
  exit 1
fi

echo "âœ… Tests and build succeeded - proceeding with commit."
